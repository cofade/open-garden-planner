name: Release

on:
  push:
    branches: [master]

permissions:
  contents: write

jobs:
  release:
    name: Build & Release
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git tags

      - name: Determine version
        id: version
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get latest tag version
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v1.0.0")
          VERSION=${LATEST_TAG#v}
          MAJOR=$(echo "$VERSION" | cut -d. -f1)
          MINOR=$(echo "$VERSION" | cut -d. -f2)
          PATCH=$(echo "$VERSION" | cut -d. -f3)

          # Get labels from the merged PR that triggered this push
          PR_NUMBER=$(gh pr list --state merged --base master --limit 1 --json number --jq '.[0].number')
          LABELS=""
          if [ -n "$PR_NUMBER" ]; then
            LABELS=$(gh pr view "$PR_NUMBER" --json labels --jq '.labels[].name' 2>/dev/null || echo "")
          fi

          # Determine bump type
          if echo "$LABELS" | grep -q "major"; then
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
          elif echo "$LABELS" | grep -q "minor"; then
            MINOR=$((MINOR + 1))
            PATCH=0
          else
            PATCH=$((PATCH + 1))
          fi

          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          echo "version=$NEW_VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=v$NEW_VERSION" >> "$GITHUB_OUTPUT"
          echo "Releasing version: $NEW_VERSION"

      - name: Check if tag already exists
        id: check_tag
        shell: bash
        run: |
          if git rev-parse "${{ steps.version.outputs.tag }}" >/dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Skip if tag exists
        if: steps.check_tag.outputs.exists == 'true'
        run: echo "Tag ${{ steps.version.outputs.tag }} already exists, skipping release."

      - name: Set up Python 3.11
        if: steps.check_tag.outputs.exists == 'false'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install pyinstaller

      - name: Install NSIS
        if: steps.check_tag.outputs.exists == 'false'
        run: choco install nsis -y

      - name: Build installer
        if: steps.check_tag.outputs.exists == 'false'
        run: python installer/build_installer.py --version ${{ steps.version.outputs.version }}

      - name: Generate checksum
        if: steps.check_tag.outputs.exists == 'false'
        shell: bash
        run: |
          cd dist
          sha256sum "OpenGardenPlanner-v${{ steps.version.outputs.version }}-Setup.exe" > SHA256SUMS.txt
          cat SHA256SUMS.txt

      - name: Create GitHub Release
        if: steps.check_tag.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: >
          gh release create ${{ steps.version.outputs.tag }}
          "dist/OpenGardenPlanner-v${{ steps.version.outputs.version }}-Setup.exe"
          "dist/SHA256SUMS.txt"
          --title "${{ steps.version.outputs.tag }}"
          --generate-notes
